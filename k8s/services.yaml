apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-a
spec:
  replicas: 1
  selector:
    matchLabels:
      app: service-a
  template:
    metadata:
      labels:
        app: service-a
      annotations:
        sidecar.istio.io/inject: "true"
        sidecar.istio.io/userVolume: '[{"name":"wasm-volume","configMap":{"name":"freeze-filter-wasm"}}]'
        sidecar.istio.io/userVolumeMount: '[{"mountPath":"/var/local/lib/wasm-filters","name":"wasm-volume"}]'
        traffic.sidecar.istio.io/excludeOutboundPorts: "4317,4318"
    spec:
      containers:
      - name: service-a
        image: dcdot-service-a:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
        - name: SERVICE_B_URL
          value: "http://service-b:8080"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "otel-collector:4317"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: service-a
spec:
  selector:
    app: service-a
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30080
  type: NodePort

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-b
spec:
  replicas: 1
  selector:
    matchLabels:
      app: service-b
  template:
    metadata:
      labels:
        app: service-b
      annotations:
        traffic.sidecar.istio.io/excludeOutboundPorts: "4317,4318,5432"  # Added 5432!
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:16-alpine
        command: 
        - sh
        - -c
        - |
          until pg_isready -h postgres -p 5432 -U dcdot; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"
      - name: wait-for-collector
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -zv otel-collector 4317; do
            echo "Waiting for OTel Collector..."
            sleep 2
          done
          echo "OTel Collector is ready!"
      containers:
      - name: service-b
        image: dcdot-service-b:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
        - name: SERVICE_C_URL
          value: "http://service-c:8080"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "otel-collector:4317"
        - name: DB_HOST
          value: "postgres"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: service-b
spec:
  selector:
    app: service-b
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-c
spec:
  replicas: 1
  selector:
    matchLabels:
      app: service-c
  template:
    metadata:
      labels:
        app: service-c
      annotations:
        traffic.sidecar.istio.io/excludeOutboundPorts: "4317,4318,5432"  # Added 5432!
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:16-alpine
        command:
        - sh
        - -c
        - |
          until pg_isready -h postgres -p 5432 -U dcdot; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"
      - name: wait-for-collector
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -zv otel-collector 4317; do
            echo "Waiting for OTel Collector..."
            sleep 2
          done
          echo "OTel Collector is ready!"
      containers:
      - name: service-c
        image: dcdot-service-c:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
        - name: SERVICE_NAME
          value: "service-c-payment"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "otel-collector:4317"
        - name: DB_HOST
          value: "postgres"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: service-c
spec:
  selector:
    app: service-c
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
